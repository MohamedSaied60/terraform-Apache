pipeline {
    agent any { label 'Agent01' }
    
    environment {
        AWS_ACCESS_KEY_ID     = credentials('AKIARUV3S7NMQ5WMG22H')
        AWS_SECRET_ACCESS_KEY = credentials('7DFIvSNPYTvuYrvMKP39dEBd+Gd8nVUTljAWeV+g')
        AWS_DEFAULT_REGION    = 'us-east-1'
        TF_VAR_your_name      = 'Your Name Here'  // UPDATE THIS
        TF_VAR_environment    = 'jenkins'
   }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
                echo 'âœ… Repository checkout completed'
            }
        }
        
        stage('Setup Terraform') {
            steps {
                sh '''
                # Install Terraform if not present
                if ! command -v terraform &> /dev/null; then
                    wget https://releases.hashicorp.com/terraform/1.6.0/terraform_1.6.0_linux_amd64.zip
                    unzip terraform_1.6.0_linux_amd64.zip
                    sudo mv terraform /usr/local/bin/
                fi
                terraform version
                '''
            }
        }
        
        stage('Terraform Init') {
            steps {
                dir('terraform-apache-project') {
                    sh 'terraform init'
                    echo 'âœ… Terraform initialized'
                }
            }
        }
        
        stage('Terraform Plan') {
            steps {
                dir('terraform-apache-project') {
                    sh 'terraform plan'
                    echo 'âœ… Terraform plan completed'
                }
            }
        }
        
        stage('Terraform Apply') {
            steps {
                dir('terraform-apache-project') {
                    sh 'terraform apply -auto-approve'
                    echo 'âœ… Infrastructure deployed'
                    
                    // Save outputs
                    sh '''
                    terraform output public_ip > public_ip.txt
                    terraform output website_url > website_url.txt
                    terraform output private_ip > private_ip.txt
                    '''
                    
                    script {
                        env.PUBLIC_IP = readFile('public_ip.txt').trim()
                        env.WEBSITE_URL = readFile('website_url.txt').trim()
                        env.PRIVATE_IP = readFile('private_ip.txt').trim()
                    }
                }
            }
        }
        
        stage('Health Check') {
            steps {
                script {
                    timeout(time: 3, unit: 'MINUTES') {
                        waitUntil {
                            try {
                                sh "curl -s -f -o /dev/null -w '%{http_code}' http://${env.PUBLIC_IP}/health.html"
                                return true
                            } catch (Exception e) {
                                echo "â³ Waiting for Apache to start... (30s)"
                                sleep 30
                                return false
                            }
                        }
                    }
                    echo 'âœ… Apache server is healthy and responding'
                }
            }
        }
        
        stage('Display Results') {
            steps {
                script {
                    echo "========================================"
                    echo "ðŸŽ‰ DEPLOYMENT SUCCESSFUL!"
                    echo "========================================"
                    echo "ðŸ‘¤ Your Name: ${TF_VAR_your_name}"
                    echo "ðŸŒ Website URL: ${env.WEBSITE_URL}"
                    echo "ðŸ”’ Private IP: ${env.PRIVATE_IP}"
                    echo "ðŸ”— Health Check: http://${env.PUBLIC_IP}/health.html"
                    echo "========================================"
                    
                    // Send to chat
                    sh """
                    echo "Deployment Summary:" > deployment_summary.txt
                    echo "Your Name: ${TF_VAR_your_name}" >> deployment_summary.txt
                    echo "Website: ${env.WEBSITE_URL}" >> deployment_summary.txt
                    echo "Private IP: ${env.PRIVATE_IP}" >> deployment_summary.txt
                    """
                }
            }
        }
    }
    
    post {
        success {
            echo 'âœ… Pipeline executed successfully!'
            echo "ðŸŒ Access your Apache server at: ${env.WEBSITE_URL}"
            archiveArtifacts artifacts: 'deployment_summary.txt', fingerprint: true
        }
        failure {
            echo 'âŒ Pipeline failed!'
        }
        always {
            // Cleanup
                dir('terraform-apache-project') {
                sh '''
                rm -f public_ip.txt website_url.txt private_ip.txt 2>/dev/null || true
                rm -f terraform.tfstate* 2>/dev/null || true
                '''
            }
        }
    }
}